# prefect.yaml

name: __PROJECT_NAME__

build:
  - prefect_docker.deployments.steps.build_docker_image:
      id: build-image
      requires: prefect-docker>=0.4.0
      image_name: "__DOCKER_REGISTRY__/__PROJECT_NAME__"
      tag: "latest"
      dockerfile: ./Dockerfile
      platform: "linux/amd64"

  - prefect_docker.deployments.steps.push_docker_image:
      id: push-image
      image_name: "{{ build-image.image_name }}"
      tag: "{{ build-image.tag }}"

pull:  # nicht n√∂tig, Code liegt im Image
  - prefect.deployments.steps.set_working_directory:
      directory: /app

deployments:
  - name: main-deployment
    entrypoint: src/__FLOW_FILE_NAME__:main_flow

    work_pool:
      name: "__WORK_POOL_NAME__"
      job_variables:
        # explizit zusammensetzen = robust
        image: "{{ build-image.image_name }}:{{ build-image.tag }}"
        image_pull_policy: Always
        env:
          PREFECT_API_URL: "__PREFECT_API_URL__"
